#!/bin/bash
# =============================================================================
# Pre-commit Hook: Secret and PII Detection
# =============================================================================
# This hook scans staged files for potential secrets, credentials, and PII
# before allowing a commit. Install with: git config core.hooksPath .githooks
# =============================================================================

set -e

echo "ğŸ”’ Scanning for secrets and sensitive data..."

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Track if we found issues
FOUND_ISSUES=0

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No files staged for commit${NC}"
    exit 0
fi

# =============================================================================
# Pattern Definitions
# =============================================================================

# High-confidence secret patterns (will block commit)
HIGH_RISK_PATTERNS=(
    # Azure
    'DefaultEndpointsProtocol=https;AccountName='
    'AccountKey=[A-Za-z0-9+/=]{86,}'
    'SharedAccessSignature=sv='
    'AZURE_CLIENT_SECRET=[^<\n]+'

    # AWS
    'AKIA[0-9A-Z]{16}'
    'aws_secret_access_key\s*=\s*[A-Za-z0-9+/]{40}'

    # Generic API Keys
    'api[_-]?key["\s]*[:=]["\s]*[A-Za-z0-9]{20,}'
    'apikey["\s]*[:=]["\s]*[A-Za-z0-9]{20,}'

    # Private Keys
    '-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
    '-----BEGIN PGP PRIVATE KEY BLOCK-----'

    # Connection Strings with passwords
    'Password=[^;<\n]{8,}'
    'pwd=[^;<\n]{8,}'

    # JWT tokens (long base64 with dots)
    'eyJ[A-Za-z0-9_-]*\.eyJ[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*'

    # GitHub tokens
    'ghp_[A-Za-z0-9]{36}'
    'gho_[A-Za-z0-9]{36}'
    'ghu_[A-Za-z0-9]{36}'
    'ghs_[A-Za-z0-9]{36}'
    'ghr_[A-Za-z0-9]{36}'

    # Slack tokens
    'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'

    # Generic secrets
    'client[_-]?secret["\s]*[:=]["\s]*[A-Za-z0-9]{20,}'
)

# PII patterns (will warn but not block)
PII_PATTERNS=(
    # SSN (raw format, not masked)
    '[0-9]{3}-[0-9]{2}-[0-9]{4}'

    # Credit card numbers
    '[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}'

    # Email addresses (except masked ones)
    '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
)

# Files to skip (test files, samples, documentation)
SKIP_PATTERNS=(
    '\.md$'
    '\.sample$'
    '\.example$'
    'test_.*\.py$'
    '_test\.py$'
    'conftest\.py$'
    'sample.*\.csv$'
    '\.env\.sample$'
    '\.env\.example$'
)

# =============================================================================
# Scanning Functions
# =============================================================================

should_skip_file() {
    local file="$1"
    for pattern in "${SKIP_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            return 0
        fi
    done
    return 1
}

scan_for_secrets() {
    local file="$1"
    local found=0

    for pattern in "${HIGH_RISK_PATTERNS[@]}"; do
        if git show ":$file" 2>/dev/null | grep -qE "$pattern"; then
            if [ $found -eq 0 ]; then
                echo -e "${RED}âŒ BLOCKED: Potential secret found in: $file${NC}"
                found=1
            fi
            echo -e "   Pattern: $pattern"
            FOUND_ISSUES=1
        fi
    done

    return $found
}

scan_for_pii() {
    local file="$1"
    local warned=0

    # Skip CSV files in sample-data (they contain intentionally masked PII)
    if echo "$file" | grep -qE 'sample-data/.*\.csv$'; then
        return 0
    fi

    for pattern in "${PII_PATTERNS[@]}"; do
        # Skip email pattern in certain files
        if [ "$pattern" = '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' ]; then
            # Allow emails in documentation and config
            if echo "$file" | grep -qE '\.(md|yml|yaml|json|bicep)$'; then
                continue
            fi
        fi

        if git show ":$file" 2>/dev/null | grep -qE "$pattern"; then
            if [ $warned -eq 0 ]; then
                echo -e "${YELLOW}âš ï¸  WARNING: Potential PII found in: $file${NC}"
                warned=1
            fi
            echo -e "   Pattern: $pattern"
        fi
    done
}

# =============================================================================
# Main Scanning Loop
# =============================================================================

echo "Scanning $(echo "$STAGED_FILES" | wc -l | tr -d ' ') staged files..."
echo ""

for file in $STAGED_FILES; do
    # Skip if file matches skip patterns
    if should_skip_file "$file"; then
        continue
    fi

    # Skip binary files
    if file "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # Scan for high-risk secrets (blocking)
    scan_for_secrets "$file"

    # Scan for PII (warning only)
    scan_for_pii "$file"
done

echo ""

# =============================================================================
# Final Result
# =============================================================================

if [ $FOUND_ISSUES -eq 1 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}COMMIT BLOCKED: Potential secrets detected!${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Please review the flagged files and:"
    echo "  1. Remove any real secrets/credentials"
    echo "  2. Use environment variables or Key Vault references"
    echo "  3. If this is a false positive, use: git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ No secrets detected. Proceeding with commit.${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
exit 0
