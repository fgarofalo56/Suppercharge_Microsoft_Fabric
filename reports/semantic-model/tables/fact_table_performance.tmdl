/// =============================================================================
/// Fact: Table Performance
/// =============================================================================
///
/// Purpose: Daily table games performance metrics
/// Grain: One row per game type per event date
/// Source: lh_gold.gold_table_analytics
/// Update Pattern: Daily append/overwrite by partition
///
/// =============================================================================

table fact_table_performance
    lineageTag: fact-table-001

    /// ==========================================================================
    /// DIMENSION KEYS
    /// ==========================================================================

    column event_date
        dataType: dateTime
        formatString: Short Date
        lineageTag: fact-table-date
        summarizeBy: none
        sourceColumn: event_date
        description: "Business date (foreign key to dim_date)"

    column game_type
        dataType: string
        lineageTag: fact-table-gametype
        summarizeBy: none
        sourceColumn: game_type
        description: "Type of game (Blackjack, Roulette, etc.)"

    column game_category
        dataType: string
        lineageTag: fact-table-category
        summarizeBy: none
        sourceColumn: game_category
        description: "Game category (Card Games, Dice Games, Wheel Games)"

    /// ==========================================================================
    /// VOLUME METRICS
    /// ==========================================================================

    column active_tables
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-active
        summarizeBy: sum
        sourceColumn: active_tables
        description: "Number of active tables"

    column total_sessions
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-sessions
        summarizeBy: sum
        sourceColumn: total_sessions
        description: "Total gaming sessions"

    column unique_players
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-players
        summarizeBy: sum
        sourceColumn: unique_players
        description: "Unique players at tables"

    column total_hands
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-hands
        summarizeBy: sum
        sourceColumn: total_hands
        description: "Total hands/rounds played"

    /// ==========================================================================
    /// FINANCIAL METRICS
    /// ==========================================================================

    column total_drop
        dataType: decimal
        formatString: \$#,##0.00
        lineageTag: fact-table-drop
        summarizeBy: sum
        sourceColumn: total_drop
        description: "Total drop (buy-ins)"

    column total_payouts
        dataType: decimal
        formatString: \$#,##0.00
        lineageTag: fact-table-payouts
        summarizeBy: sum
        sourceColumn: total_payouts
        description: "Total player payouts"

    column table_win
        dataType: decimal
        formatString: \$#,##0.00
        lineageTag: fact-table-win
        summarizeBy: sum
        sourceColumn: table_win
        description: "Casino win (Drop - Payouts)"

    /// ==========================================================================
    /// KPIs
    /// ==========================================================================

    column hold_pct
        dataType: decimal
        formatString: 0.00%
        lineageTag: fact-table-holdpct
        summarizeBy: average
        sourceColumn: hold_pct
        description: "Actual hold percentage"

    column expected_hold_pct
        dataType: decimal
        formatString: 0.00%
        lineageTag: fact-table-expholdpct
        summarizeBy: average
        sourceColumn: expected_hold_pct
        description: "Expected hold percentage for game type"

    column hold_variance
        dataType: decimal
        formatString: 0.00%
        lineageTag: fact-table-variance
        summarizeBy: average
        sourceColumn: hold_variance
        description: "Hold variance (actual - expected)"

    column hold_variance_status
        dataType: string
        lineageTag: fact-table-varstatus
        summarizeBy: none
        sourceColumn: hold_variance_status
        description: "Variance status (NORMAL, HIGH_HOLD, LOW_HOLD)"

    /// ==========================================================================
    /// OPERATIONAL METRICS
    /// ==========================================================================

    column avg_bet
        dataType: decimal
        formatString: \$#,##0.00
        lineageTag: fact-table-avgbet
        summarizeBy: average
        sourceColumn: avg_bet
        description: "Average bet size"

    column max_bet
        dataType: decimal
        formatString: \$#,##0.00
        lineageTag: fact-table-maxbet
        summarizeBy: max
        sourceColumn: max_bet
        description: "Maximum single bet"

    column hands_per_table
        dataType: decimal
        formatString: #,##0.0
        lineageTag: fact-table-hpt
        summarizeBy: average
        sourceColumn: hands_per_table
        description: "Average hands per table"

    column drop_per_player
        dataType: decimal
        formatString: \$#,##0.00
        lineageTag: fact-table-dpp
        summarizeBy: average
        sourceColumn: drop_per_player
        description: "Average drop per player"

    column sessions_per_player
        dataType: decimal
        formatString: #,##0.0
        lineageTag: fact-table-spp
        summarizeBy: average
        sourceColumn: sessions_per_player
        description: "Sessions per player"

    /// ==========================================================================
    /// QUALITY & ALERTS
    /// ==========================================================================

    column avg_dq_score
        dataType: decimal
        formatString: 0.0
        lineageTag: fact-table-dq
        summarizeBy: average
        sourceColumn: avg_dq_score
        description: "Average data quality score"

    column large_bet_count
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-largebets
        summarizeBy: sum
        sourceColumn: large_bet_count
        description: "Count of large bets"

    column big_swing_count
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-swings
        summarizeBy: sum
        sourceColumn: big_swing_count
        description: "Count of significant win/loss swings"

    column performance_alerts
        dataType: string
        lineageTag: fact-table-alerts
        summarizeBy: none
        sourceColumn: performance_alerts
        description: "Alert flags array"
        isHidden: true

    column alert_count
        dataType: int64
        formatString: #,##0
        lineageTag: fact-table-alertcnt
        summarizeBy: sum
        sourceColumn: alert_count
        description: "Number of active alerts"

    /// ==========================================================================
    /// METADATA
    /// ==========================================================================

    column _gold_timestamp
        dataType: dateTime
        formatString: General Date
        lineageTag: fact-table-ts
        summarizeBy: none
        sourceColumn: _gold_timestamp
        isHidden: true

    column _batch_id
        dataType: string
        lineageTag: fact-table-batch
        summarizeBy: none
        sourceColumn: _batch_id
        isHidden: true

    /// ==========================================================================
    /// PARTITION
    /// ==========================================================================

    partition 'fact_table_performance-directlake' = entity
        mode: directLake
        source
            entityPath: gold_table_analytics
            schemaName: dbo
            expressionSource: 'DirectLake'
